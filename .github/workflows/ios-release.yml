name: iOS Release to App Store Connect

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes for this build'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          
      - name: Get Flutter dependencies
        run: flutter pub get
        
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update
          cd ..
        
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios
          
      - name: Install Fastlane
        run: |
          cd ios
          gem install bundler
          bundle install
          
      - name: Build Flutter iOS (embed Supabase config)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          flutter build ios --no-codesign \
            --dart-define=SUPABASE_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"
          
      - name: Setup App Store Connect API Key for Automatic Signing
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "Setting up App Store Connect API Key for automatic signing..."
          
          # Create API key file for Xcode automatic signing
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          echo "✅ API Key installed"
          echo "Xcode will automatically download certificates and provisioning profiles"
          
      - name: Build and upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: false
          BUILD_NUMBER: ${{ github.run_number }}
          TEAM_ID: YWQH3Z3Z85
        run: |
          cd ios
          bundle exec fastlane beta
          
      - name: Clean up secrets
        if: always()
        run: |
          rm -rf ~/private_keys || true
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ios/build/Runner.ipa
            ios/*.ipa
          retention-days: 30
          
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Successfully uploaded build to TestFlight!"
          echo "Build will be available for testing once processed by Apple."
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Build or upload failed. Check the logs above for details."
