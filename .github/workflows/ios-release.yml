name: iOS Release to App Store Connect (Certificate-Based)
# Last updated: 2026-02-09 11:11 UTC
# Uses certificate-based approach with BUILD_CERTIFICATE_BASE64

on:
  push:
    branches:
      - release/*
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes for this build'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Verify required secrets (Certificate-Based)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          echo "Verifying certificate-based GitHub secrets are set..."
          
          # Certificate-based approach secrets
          CERTIFICATE_SECRETS=(
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
            "APP_STORE_CONNECT_API_KEY_ID"
            "APP_STORE_CONNECT_API_KEY_ISSUER_ID"
            "APP_STORE_CONNECT_API_KEY_CONTENT"
            "BUILD_CERTIFICATE_BASE64"
            "P12_PASSWORD"
            "BUILD_PROVISION_PROFILE_BASE64"
          )
          
          all_secrets_present=true
          for secret in "${CERTIFICATE_SECRETS[@]}"; do
            if [ -n "${!secret}" ]; then
              # Show first 5 chars for verification (safe for debugging)
              value="${!secret}"
              prefix="${value:0:5}"
              echo "‚úÖ $secret is set (starts with: '$prefix...')"
            else
              echo "‚ùå $secret is NOT set or empty"
              all_secrets_present=false
            fi
          done
          
          if [ "$all_secrets_present" = false ]; then
            echo ""
            echo "‚ö†Ô∏è Missing certificate-based secrets."
            echo "This workflow uses certificate-based signing approach."
            echo "Required secrets:"
            echo "  - APP_STORE_CONNECT_API_KEY_ID"
            echo "  - APP_STORE_CONNECT_API_KEY_ISSUER_ID"
            echo "  - APP_STORE_CONNECT_API_KEY_CONTENT (.p8 file content)"
            echo "  - BUILD_CERTIFICATE_BASE64 (.p12 certificate in base64)"
            echo "  - P12_PASSWORD (password for .p12 certificate)"
            echo "  - BUILD_PROVISION_PROFILE_BASE64 (.mobileprovision in base64)"
            echo "  - SUPABASE_URL"
            echo "  - SUPABASE_ANON_KEY"
            echo ""
            echo "See SECRETS_SIMPLE.md for setup instructions."
            exit 1
          fi
          
          echo "Team ID: YWQH3Z3Z85 (hardcoded in workflow)"
          echo "‚úÖ All certificate-based secrets verified"
        
      - name: Debug API Key Format
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "=== API Key Format Debug ==="
          echo "First 50 characters of APP_STORE_CONNECT_API_KEY_CONTENT:"
          echo "${APP_STORE_CONNECT_API_KEY_CONTENT:0:50}"
          echo ""
          echo "Checking if content is PEM or Base64 encoded..."
          
          # Check if it starts with PEM header
          if echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | grep -q "BEGIN PRIVATE KEY"; then
            echo "‚úÖ PEM format detected (starts with 'BEGIN PRIVATE KEY')"
            echo "Content is plain PEM text, not base64 encoded."
            echo "Setting APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: false"
            echo "APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64=false" >> $GITHUB_ENV
          else
            echo "‚ùì Might be base64 encoded"
            echo "Attempting base64 decode..."
            DECODED=$(echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode 2>/dev/null | head -5)
            if echo "$DECODED" | grep -q "BEGIN PRIVATE KEY"; then
              echo "‚úÖ Base64 encoded PEM detected (decodes to 'BEGIN PRIVATE KEY')"
              echo "Content is base64 encoded PEM."
              echo "Setting APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: true"
              echo "APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64=true" >> $GITHUB_ENV
            else
              echo "‚ö†Ô∏è Could not determine format. Assuming PEM text (not base64)."
              echo "Setting APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: false"
              echo "APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64=false" >> $GITHUB_ENV
            fi
          fi
        
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          cache-key: flutter-v3.38.7
          
      - name: Get Flutter dependencies
        run: |
          flutter pub get
          # Check for dependency conflicts
          flutter pub deps --style=tree | head -100
        
      - name: Analyze Flutter code
        run: |
          flutter analyze --no-fatal-infos || echo "‚ö†Ô∏è Flutter analysis found issues (continuing anyway)"
        
      - name: Set up Ruby
        run: |
          # Use system Ruby on macOS runner (already installed)
          ruby --version
          gem --version
          # Install bundler if not present
          gem install bundler --no-document
          bundle --version
          echo "Ruby environment ready"
          
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          gem install cocoapods
          pod install --repo-update
          cd ..
          
      - name: Install Fastlane
        run: |
          cd ios
          gem install bundler
          bundle install
          
      - name: Setup Certificates and Provisioning Profiles
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          echo "=== SETTING UP CERTIFICATES AND PROVISIONING PROFILES ==="
          
          # Create temporary directory for certificates
          mkdir -p ~/certs
          
          # Decode certificate from base64
          echo "Decoding distribution certificate..."
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > ~/certs/distribution.p12
          echo "‚úÖ Certificate decoded and saved as ~/certs/distribution.p12"
          
          # Decode provisioning profile from base64
          echo "Decoding provisioning profile..."
          echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > ~/certs/AppStore.mobileprovision
          echo "‚úÖ Provisioning profile decoded and saved as ~/certs/AppStore.mobileprovision"
          
          # Create keychain and import certificate
          echo "Creating temporary keychain..."
          security create-keychain -p "$P12_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$P12_PASSWORD" build.keychain
          
          echo "Importing distribution certificate..."
          security import ~/certs/distribution.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          
          echo "Setting keychain settings..."
          security set-keychain-settings -t 3600 -u build.keychain
          
          # List certificates in keychain for verification
          echo "Listing certificates in keychain:"
          security find-identity -p codesigning -v build.keychain
          
          # Install provisioning profile
          echo "Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ~/certs/AppStore.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          
          echo "‚úÖ Certificates and profiles setup complete"
          
      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "Setting up App Store Connect API Key..."
          mkdir -p ~/private_keys
          
          # Check if we detected base64 encoding in previous step
          if [ "$APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64" = "true" ]; then
            echo "üîß Detected base64 encoded API key content. Decoding..."
            echo "$APP_STORE_CONNECT_API_KEY_CONTENT" | base64 --decode > ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
            echo "‚úÖ Decoded base64 to PEM format"
          else
            echo "üîß Using PEM format directly..."
            echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          fi
          
          chmod 600 ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          echo "‚úÖ API Key installed for Fastlane & Xcode"
          echo "Key ID: ${APP_STORE_CONNECT_API_KEY_ID}"
          echo "Key file: ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          echo "Format: $([ "$APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64" = "true" ] && echo "Base64 decoded to PEM" || echo "PEM directly")"
          
      - name: Build Flutter iOS (embed Supabase config)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Building Flutter iOS with Supabase configuration..."
          echo "Supabase URL: ${SUPABASE_URL:0:30}..."
          flutter clean
          flutter build ios --release --no-codesign \
            --dart-define=SUPABASE_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
            --verbose 2>&1 | tee build.log || (echo "Build failed"; cat build.log; exit 1)
          
      - name: Build and upload to TestFlight (Certificate-Based)
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: ${{ env.APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64 || 'false' }}
          BUILD_NUMBER: ${{ github.run_number }}
          TEAM_ID: YWQH3Z3Z85
        run: |
          echo "=== CICD DEBUG INFORMATION ==="
          echo "Build Number: $BUILD_NUMBER"
          echo "Team ID: $TEAM_ID"
          echo "Key ID: $APP_STORE_CONNECT_API_KEY_ID"
          echo "Issuer ID: $APP_STORE_CONNECT_API_KEY_ISSUER_ID"
          echo "Key Format: $APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64"
          echo "Bundle ID: com.cross.app"
          echo "Using: Certificate-Based Signing Approach"
          echo ""
          
          cd ios
          
          # Debug: Check if API key file exists and has correct format
          echo "Checking API key file..."
          ls -la ~/private_keys/
          echo ""
          
          # Debug: Check if certificates are in keychain
          echo "Checking certificates in keychain..."
          security find-identity -p codesigning -v build.keychain || echo "Keychain check may have issues"
          echo ""
          
          echo "=== RUNNING FASTLANE BETA (CERTIFICATE-BASED) ==="
          bundle exec fastlane beta --verbose
          
      - name: Clean up certificates and keychain
        if: always()
        run: |
          echo "Cleaning up certificates and keychain..."
          security delete-keychain build.keychain 2>/dev/null || true
          rm -rf ~/certs 2>/dev/null || true
          rm -rf ~/private_keys 2>/dev/null || true
          echo "‚úÖ Cleanup completed"
          
      - name: Clean up secrets
        if: always()
        run: |
          rm -rf ~/private_keys || true
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ios/build/Runner.ipa
            ios/*.ipa
          retention-days: 30
          
      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Successfully uploaded build to TestFlight using certificate-based signing!"
          echo "Build will be available for testing once processed by Apple."
          
      - name: Capture build logs on failure
        if: failure()
        run: |
          echo "‚ùå Build or upload failed. Gathering diagnostic information..."
          
          # Try to capture any available logs
          if [ -d "ios/build" ]; then
            echo "=== iOS Build Directory Contents ==="
            find ios/build -type f -name "*.log" | head -5
          fi
          
          if [ -d "build" ]; then
            echo "=== Flutter Build Directory Contents ==="
            find build -type f -name "*.log" | head -5
          fi
          
          echo "=== Check Flutter Doctor ==="
          flutter doctor -v 2>&1 | tail -20 || true
          
          echo "=== Check CocoaPods ==="
          cd ios && pod --version || true
          cd ..
          
          echo "=== Certificate Debug Info ==="
          echo "Checking keychain..."
          security list-keychains || true
          echo ""
          
          echo "‚ùå Check the logs above for specific error messages"