name: iOS Release to App Store Connect (Automatic Signing)
# Last updated: 2026-02-13 10:47 UTC

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes for this build'
        required: false
        default: 'Bug fixes and improvements'

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Verify required secrets
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "Verifying required GitHub secrets are set..."
          REQUIRED_SECRETS=("SUPABASE_URL" "SUPABASE_ANON_KEY" "APP_STORE_CONNECT_API_KEY_ID" "APP_STORE_CONNECT_API_ISSUER_ID" "APP_STORE_CONNECT_API_KEY_CONTENT")
          
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -n "${!secret}" ]; then
              # Show first 5 chars for verification (safe for debugging)
              value="${!secret}"
              prefix="${value:0:5}"
              echo "✅ $secret is set (starts with: '$prefix...')"
            else
              echo "❌ $secret is NOT set or empty"
              exit 1
            fi
          done
          
          echo "Team ID: YWQH3Z3Z85 (hardcoded in workflow)"
        
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true
          cache-key: flutter-v3.38.7
          
      - name: Get Flutter dependencies
        run: |
          flutter pub get
          # Check for dependency conflicts
          flutter pub deps --style=tree | head -100
        
      - name: Analyze Flutter code
        run: |
          flutter analyze --no-fatal-infos || echo "⚠️ Flutter analysis found issues (continuing anyway)"
        
      - name: Set up Ruby
        run: |
          # Use system Ruby on macOS runner (already installed)
          ruby --version
          gem --version
          # Install bundler if not present
          gem install bundler --no-document
          bundle --version
          echo "Ruby environment ready"
          
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          gem install cocoapods
          pod install --repo-update
          cd ..
          
      - name: Install Fastlane
        run: |
          cd ios
          gem install bundler
          bundle install
          
      - name: Setup API Key for Automatic Signing
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "Setting up App Store Connect API Key for automatic signing..."
          mkdir -p ~/private_keys
          
          # Write the API key content to a .p8 file
          # The content should already be in PEM format
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          chmod 600 ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          echo "✅ API Key installed for automatic signing"
          echo "Key ID: ${APP_STORE_CONNECT_API_KEY_ID}"
          echo "Key file: ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          
      - name: Build Flutter iOS (embed Supabase config)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Building Flutter iOS with Supabase configuration..."
          echo "Supabase URL: ${SUPABASE_URL:0:30}..."
          
          # Clean and build with automatic code signing
          flutter clean
          flutter build ios --release \
            --dart-define=SUPABASE_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
            --no-codesign 2>&1 | tee build.log || (echo "Build failed"; cat build.log; exit 1)
          
          echo "✅ Flutter iOS build completed"
          
      - name: Build and upload to TestFlight (Automatic Signing)
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          TEAM_ID: YWQH3Z3Z85
          BUILD_NUMBER: ${{ github.run_number }}
          # Optional: set PROVISIONING_PROFILE_NAME in repo vars or secrets to pre-install that profile before build
          PROVISIONING_PROFILE_NAME: ${{ vars.PROVISIONING_PROFILE_NAME || secrets.PROVISIONING_PROFILE_NAME }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          FASTLANE_ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
        run: |
          echo "=== AUTOMATIC SIGNING CONFIGURATION ==="
          echo "Build Number: $BUILD_NUMBER"
          echo "Team ID: $TEAM_ID"
          echo "Key ID: $APP_STORE_CONNECT_API_KEY_ID"
          echo "Issuer ID: $APP_STORE_CONNECT_API_KEY_ISSUER_ID"
          echo "Bundle ID: com.cross.app"
          echo ""
          
          cd ios
          
          # Verify Xcode project is configured for automatic signing
          echo "Checking Xcode project configuration..."
          if grep -q "DevelopmentTeam = YWQH3Z3Z85" Runner.xcodeproj/project.pbxproj; then
            echo "✅ Development team configured in project"
          else
            echo "⚠️ Development team not found in project"
          fi
          
          if grep -q "ProvisioningStyle = Automatic" Runner.xcodeproj/project.pbxproj; then
            echo "✅ Automatic signing configured in project"
          else
            echo "⚠️ Automatic signing not configured in project"
          fi
          
          echo "=== RUNNING FASTLANE BETA (AUTOMATIC SIGNING) ==="
          
          # Run Fastlane with environment variables for automatic signing
          # Fastlane will use the API key for authentication
          bundle exec fastlane beta
          
      - name: Clean up secrets
        if: always()
        run: |
          rm -rf ~/private_keys || true
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-artifacts
          path: |
            ios/build/Runner.ipa
            ios/*.ipa
          retention-days: 30
          
      - name: Notify on success
        if: success()
        run: |
          echo "✅ Successfully uploaded build to TestFlight using automatic signing!"
          echo "Build will be available for testing once processed by Apple."
          
      - name: Capture build logs on failure
        if: failure()
        run: |
          echo "❌ Build or upload failed. Gathering diagnostic information..."
          
          # Try to capture any available logs
          if [ -d "ios/build" ]; then
            echo "=== iOS Build Directory Contents ==="
            find ios/build -type f -name "*.log" -o -name "*.txt" | head -10
          fi
          
          if [ -f "build.log" ]; then
            echo "=== Flutter Build Log (last 100 lines) ==="
            tail -100 build.log
          fi
          
          echo "=== Flutter Doctor ==="
          flutter doctor -v 2>&1 | tail -30 || true
          
          echo "❌ Check the logs above for specific error messages"
