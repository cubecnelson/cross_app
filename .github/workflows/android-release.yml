name: Android Release to QR
# Builds Android APK and generates QR code linking to artifact
# Manual trigger only for security

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug or release)'
        required: true
        default: 'release'
        type: choice
        options:
        - debug
        - release
      flutter_version:
        description: 'Flutter version to use'
        required: false
        default: '3.38.7'
      generate_qr:
        description: 'Generate QR code for artifact'
        required: false
        default: true
        type: boolean

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Java (for Android builds)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools-version: "34.0.0"
          ndk-version: "26.1.10909125"
          cmake-version: "3.22.1"
          targets: "android-34"
          arch: "x86_64"
          
      - name: Accept Android Licenses
        run: |
          echo "=== ACCEPTING ANDROID LICENSES ==="
          # Try multiple methods to accept licenses
          echo "Method 1: Using sdkmanager..."
          yes | sdkmanager --licenses || echo "sdkmanager method may have failed"
          
          echo "Method 2: Using flutter doctor..."
          flutter doctor --android-licenses -y || echo "flutter doctor method may have failed"
          
          echo "Method 3: Direct license file creation..."
          mkdir -p "$ANDROID_HOME/licenses"
          echo -e "\n24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
          echo "âœ… License files created"
          
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ inputs.flutter_version || '3.38.7' }}
          channel: 'stable'
          cache: true
          cache-key: flutter-android-${{ inputs.flutter_version || '3.38.7' }}
          
      - name: Verify Flutter installation
        run: |
          echo "=== FLUTTER ENVIRONMENT ==="
          flutter --version
          flutter doctor -v
          
      - name: Check Android SDK Status
        run: |
          echo "=== ANDROID SDK STATUS ==="
          flutter doctor
          echo ""
          echo "Checking Android SDK components..."
          which sdkmanager || echo "sdkmanager not found"
          which adb || echo "adb not found"
          echo ""
          echo "Android SDK path check:"
          if [ -n "$ANDROID_HOME" ]; then
            echo "ANDROID_HOME: $ANDROID_HOME"
            ls -la "$ANDROID_HOME" || echo "Cannot list ANDROID_HOME"
          elif [ -n "$ANDROID_SDK_ROOT" ]; then
            echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
            ls -la "$ANDROID_SDK_ROOT" || echo "Cannot list ANDROID_SDK_ROOT"
          else
            echo "Neither ANDROID_HOME nor ANDROID_SDK_ROOT set"
          fi
          
      - name: Get Flutter dependencies
        run: |
          echo "Getting dependencies..."
          flutter pub get
          echo "Dependencies installed"
          
      - name: Check Android project structure
        run: |
          echo "=== ANDROID PROJECT CHECK ==="
          if [ -d "android" ]; then
            echo "âœ… Android directory exists"
            echo "Android project structure:"
            find android -maxdepth 2 -type f -name "*.gradle" -o -name "AndroidManifest.xml" -o -name "build.gradle" | sort
          else
            echo "âš ï¸ Android directory not found"
            echo "Creating Android project structure..."
            # First check if Flutter can create Android project
            echo "Current directory contents:"
            ls -la
            echo ""
            echo "Creating Android platform support..."
            flutter config --enable-android
            flutter create --platforms=android --no-overwrite . || {
              echo "âš ï¸ Could not create with --no-overwrite, trying without..."
              # Create a temporary directory to avoid overwriting
              mkdir -p temp_android_create
              cd temp_android_create
              flutter create --platforms=android --project-name cross_temp .
              # Copy android directory if created
              if [ -d "android" ]; then
                cd ..
                cp -r temp_android_create/android .
                rm -rf temp_android_create
                echo "âœ… Android project created via temp directory"
              else
                echo "âŒ Failed to create Android project"
                echo "Trying alternative: flutter create ."
                flutter create --platforms=android .
              fi
            }
            echo "âœ… Android project creation attempted"
          fi
          
      - name: Analyze Flutter code
        run: |
          echo "Running code analysis..."
          flutter analyze --no-fatal-infos || echo "âš ï¸ Analysis completed with warnings"
          
      - name: Clean previous builds
        run: |
          echo "Cleaning previous builds..."
          flutter clean || echo "Clean command completed"
          rm -rf build/android 2>/dev/null || true
          mkdir -p build/android
          
      - name: Build Android APK
        run: |
          echo "=== BUILDING ANDROID APK (${{ inputs.build_type }}) ==="
          
          # Create build directory if it doesn't exist
          mkdir -p build/android
          
          # Check if secrets are available
          echo "=== CHECKING SECRETS ==="
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "âš ï¸ SUPABASE_URL secret not set, using placeholder"
            SUPABASE_URL_VALUE="placeholder_url"
          else
            SUPABASE_URL_VALUE="${{ secrets.SUPABASE_URL }}"
            echo "âœ… SUPABASE_URL secret is set"
          fi
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "âš ï¸ SUPABASE_ANON_KEY secret not set, using placeholder"
            SUPABASE_ANON_KEY_VALUE="placeholder_key"
          else
            SUPABASE_ANON_KEY_VALUE="${{ secrets.SUPABASE_ANON_KEY }}"
            echo "âœ… SUPABASE_ANON_KEY secret is set"
          fi
          
          # Build APK with fallback options
          echo "Attempting APK build..."
          
          # First try with environment variables
          if [ "${{ inputs.build_type }}" = "release" ]; then
            echo "Building release APK (attempt 1) with Supabase config..."
            flutter build apk --release --no-tree-shake-icons \
              --dart-define=SUPABASE_URL="$SUPABASE_URL_VALUE" \
              --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY_VALUE" \
              --verbose 2>&1 | tee build/android/build.log || {
                echo "âš ï¸ Build attempt 1 failed, trying without dart-define..."
                flutter build apk --release --no-tree-shake-icons --verbose 2>&1 | tee -a build/android/build.log || {
                  echo "âš ï¸ Release build failed, trying debug build as fallback..."
                  flutter build apk --debug --verbose 2>&1 | tee -a build/android/build.log
                }
              }
          else
            echo "Building debug APK (attempt 1) with Supabase config..."
            flutter build apk --debug --no-tree-shake-icons \
              --dart-define=SUPABASE_URL="$SUPABASE_URL_VALUE" \
              --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY_VALUE" \
              --verbose 2>&1 | tee build/android/build.log || {
                echo "âš ï¸ Build attempt 1 failed, trying without dart-define..."
                flutter build apk --debug --verbose 2>&1 | tee -a build/android/build.log
              }
          fi
          
          echo "âœ… APK build process completed"
          
      - name: Locate APK file
        run: |
          echo "=== LOCATING APK FILE ==="
          # Find APK file with multiple possible locations
          APK_PATH=""
          
          # Check common Flutter APK output locations
          POSSIBLE_PATHS=(
            "build/app/outputs/flutter-apk/app-release.apk"
            "build/app/outputs/flutter-apk/app-debug.apk"
            "build/app/outputs/apk/release/app-release.apk"
            "build/app/outputs/apk/debug/app-debug.apk"
            "build/app/outputs/flutter-apk/app.apk"
            "build/app/outputs/apk/app.apk"
          )
          
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path" ]; then
              APK_PATH="$path"
              echo "âœ… Found APK at: $path"
              break
            fi
          done
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK file not found in expected locations"
            echo "Searching for APK files in build directory..."
            find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            
            echo ""
            echo "=== BUILD DIRECTORY STRUCTURE ==="
            find build -type f -name "*.log" -o -name "*.txt" 2>/dev/null | head -20
            
            echo ""
            echo "=== FLUTTER BUILD OUTPUT ==="
            if [ -f "build/android/build.log" ]; then
              tail -100 build/android/build.log
            fi
            
            echo ""
            echo "âš ï¸ APK not generated. Build may have failed."
            echo "Check build/android/build.log for details."
            exit 1
          fi
          
          echo "âœ… APK located: $APK_PATH"
          echo "APK_SIZE=$(du -h "$APK_PATH" | cut -f1)"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK_SIZE=$(du -h "$APK_PATH" | cut -f1)" >> $GITHUB_ENV
          
      - name: Build Troubleshooting (on failure)
        if: failure()
        run: |
          echo "=== BUILD TROUBLESHOOTING ==="
          echo ""
          echo "ðŸ“‹ Common Android build issues:"
          echo "1. Missing Android SDK licenses - Run: flutter doctor --android-licenses"
          echo "2. Missing Android SDK components - Check Android SDK installation"
          echo "3. Flutter version mismatch - Ensure Flutter 3.38.7+"
          echo "4. Missing Android project - android/ directory should exist"
          echo "5. Java version issues - Need Java 17"
          echo ""
          echo "ðŸ“ Directory structure:"
          ls -la
          echo ""
          echo "ðŸ“± Android project check:"
          if [ -d "android" ]; then
            echo "android/ directory exists"
            find android -name "*.gradle" -o -name "AndroidManifest.xml" | head -10
          else
            echo "âŒ android/ directory missing"
          fi
          echo ""
          echo "ðŸ”§ Flutter doctor output:"
          flutter doctor
          echo ""
          echo "ðŸ“„ Build logs (last 50 lines):"
          if [ -f "build/android/build.log" ]; then
            tail -50 build/android/build.log
          else
            echo "No build log found"
          fi
          
      - name: Generate QR Code for Artifact
        if: ${{ inputs.generate_qr == true }}
        run: |
          echo "=== GENERATING QR CODE ==="
          
          # Create artifact URL (will be available after upload)
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Install QR code generator
          sudo apt-get update
          sudo apt-get install -y qrencode
          
          # Generate QR code
          mkdir -p build/qr
          qrencode -o build/qr/apk-qr.png -s 10 "$ARTIFACT_URL"
          
          echo "âœ… QR code generated: build/qr/apk-qr.png"
          echo "QR_CODE_PATH=build/qr/apk-qr.png" >> $GITHUB_ENV
          
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cross-android-apk-${{ github.run_id }}
          path: |
            ${{ env.APK_PATH }}
            build/android/build.log
          retention-days: 90
          
      - name: Upload QR Code Artifact
        if: ${{ inputs.generate_qr == true }}
        uses: actions/upload-artifact@v4
        with:
          name: cross-apk-qr-${{ github.run_id }}
          path: |
            ${{ env.QR_CODE_PATH }}
          retention-days: 90
          
      - name: Create Release Information
        run: |
          echo "=== RELEASE INFORMATION ==="
          echo ""
          echo "ðŸ“± ANDROID APK BUILD COMPLETE"
          echo ""
          echo "Build Type: ${{ inputs.build_type }}"
          echo "Flutter Version: ${{ inputs.flutter_version || '3.38.7' }}"
          echo "APK Size: ${{ env.APK_SIZE }}"
          echo "APK Path: ${{ env.APK_PATH }}"
          echo ""
          echo "ðŸ“¦ ARTIFACTS AVAILABLE:"
          echo "1. APK file: Download from Actions artifacts"
          echo "2. Build logs: Available in artifacts"
          if [ "${{ inputs.generate_qr }}" = "true" ]; then
            echo "3. QR Code: Scan to open artifact page"
          fi
          echo ""
          echo "ðŸ”— DIRECT LINKS:"
          echo "Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ“ INSTALLATION INSTRUCTIONS:"
          echo "1. Download APK from artifacts"
          echo "2. Enable 'Install from unknown sources' on Android device"
          echo "3. Install APK"
          echo ""
          echo "âš ï¸ SECURITY NOTE:"
          echo "Debug builds are for testing only."
          echo "Release builds should be signed for production distribution."
          
      - name: Output Summary
        run: |
          echo "SUMMARY_BUILD_TYPE=${{ inputs.build_type }}" >> $GITHUB_ENV
          echo "SUMMARY_APK_SIZE=${{ env.APK_SIZE }}" >> $GITHUB_ENV
          echo "SUMMARY_ARTIFACT_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV